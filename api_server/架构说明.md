# BentoML API服务架构说明

## 总体架构

本服务采用 **BentoML** 框架构建，提供统一的REST API接口，支持5种任务类型的处理。

```
                                   BentoML服务
                                       ↓
                          ┌─────────────────────────┐
                          │   service.py            │
                          │   InspectionAPIService  │
                          └─────────────────────────┘
                                       ↓
                          ┌─────────────────────────┐
                          │   loader.py             │
                          │   动态加载处理器         │
                          └─────────────────────────┘
                                       ↓
                 ┌─────────────────────────────────────────────┐
                 │              config.yaml                     │
                 │           配置所有任务处理器                  │
                 └─────────────────────────────────────────────┘
                                       ↓
        ┌──────────────┬───────────────┬──────────────┬──────────────┬──────────────┐
        │              │               │              │              │              │
   ┌────▼────┐   ┌────▼────┐    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐        │
   │ Task 1  │   │ Task 2  │    │ Task 3  │    │ Task 4  │    │ Task 5  │        │
   │ 指针读数 │   │ 高温检测 │    │ 烟雾判断A│    │ 烟雾判断B│    │ 物品描述 │        │
   └────┬────┘   └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘        │
        │              │               │              │              │              │
        ↓              ↓               ↓              ↓              ↓              │
   DashScope       温度计算         DashScope      DashScope      DashScope         │
   大模型API        本地处理         大模型API       大模型API       大模型API         │
```

## 核心组件

### 1. service.py - BentoML服务入口

**职责**:
- 定义BentoML服务
- 提供统一的API接口 `/api/process`
- 根据`task_type`路由到不同的处理器
- 统一的错误处理和日志记录

**关键接口**:
- `GET /health`: 健康检查
- `POST /api/process`: 统一处理接口

### 2. loader.py - 项目加载器

**职责**:
- 读取 `config.yaml` 配置文件
- 动态加载任务处理器
- 创建路由处理函数
- 统一的请求/响应格式化

**关键函数**:
- `load_config()`: 加载配置文件
- `load_project_from_path()`: 动态加载处理器
- `get_all_active_projects()`: 获取所有启用的处理器
- `create_route_handler()`: 为每个处理器创建handler

### 3. base_project.py - 任务处理器基类

**职责**:
- 定义处理器的标准接口
- 强制子类实现必要的方法

**必须实现的方法**:
- `get_project_name()`: 返回项目名称
- `get_project_description()`: 返回项目描述
- `validate_input()`: 验证输入数据
- `process()`: 核心处理逻辑

### 4. utils.py - 工具函数模块

**职责**:
- DashScope API调用封装
- 图片保存功能
- 状态判断逻辑
- JSON解析辅助

**关键类/函数**:
- `DashScopeHelper`: DashScope调用辅助类
- `save_image()`: 保存图片到磁盘
- `determine_status()`: 根据阈值判断状态

### 5. 任务处理器 (processors/)

每个任务处理器继承自 `BaseProject`，实现特定的处理逻辑。

#### Task 1: 指针仪表读数 (task1_pointer_reader)
- 调用DashScope视觉模型
- 识别指针位置和读数
- 返回数值、单位、置信度

#### Task 2: 高温物体检测 (task2_temperature)
- 不调用大模型，本地处理
- 根据温度阈值判断状态
- 返回温度数据和状态

#### Task 3/4: 烟雾判断 (task3_smoke_a / task4_smoke_b)
- 调用DashScope视觉模型
- 判断是否存在烟雾
- 返回烟雾类型、密度、置信度

#### Task 5: 物品描述 (task5_object_description)
- 调用DashScope视觉模型
- 识别A4纸上放置的物品
- 返回物品描述、物品列表、数量、置信度

## 数据流

```
1. 小车发送请求 → POST /api/process
   ↓
2. service.py 接收请求
   - 验证参数（task_type, station_id）
   - 解析图片和额外参数
   ↓
3. 根据 task_type 选择处理器
   - task_type=1 → task1_pointer_reader
   - task_type=2 → task2_temperature
   - task_type=3 → task3_smoke_a
   - task_type=4 → task4_smoke_b
   - task_type=5 → task5_object_description
   ↓
4. 调用处理器的 handler
   - 解析请求数据（图片+参数）
   - 验证输入（validate_input）
   - 执行处理逻辑（process）
   ↓
5. 处理器执行
   - 保存图片到磁盘
   - 调用大模型（如需要）
   - 计算结果
   - 返回统一格式的结果
   ↓
6. 返回响应给小车
   - 成功: {"status": "success", "data": {...}}
   - 失败: {"status": "error", "error": {...}}
```

## 配置管理

### config.yaml

定义所有任务处理器的配置：

```yaml
projects:
  - name: task1_pointer_reader
    enabled: true
    description: "指针式仪表读数识别"
    project_path: "processors/task1_pointer_reader"
    params:
      model: "qwen-vl-plus"
```

**关键字段**:
- `name`: 处理器名称（唯一标识）
- `enabled`: 是否启用
- `project_path`: 处理器代码路径
- `params`: 处理器参数

### .env

环境变量配置：

```
DASHSCOPE_API_KEY=sk-xxx
DASHSCOPE_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

## 扩展性设计

### 添加新任务处理器

1. 在 `processors/` 下创建新目录
2. 创建 `processor.py`，继承 `BaseProject`
3. 实现必要方法
4. 在 `config.yaml` 中注册

**示例**:

```python
class NewTaskProcessor(BaseProject):
    def get_project_name(self) -> str:
        return "task5_new_task"
    
    def get_project_description(self) -> str:
        return "新任务描述"
    
    def validate_input(self, data: Dict[str, Any]) -> bool:
        # 验证逻辑
        return True
    
    def process(self, data: Dict[str, Any]) -> Dict[str, Any]:
        # 处理逻辑
        return {...}
```

在 `config.yaml` 中添加：

```yaml
projects:
  - name: task5_new_task
    enabled: true
    description: "新任务"
    project_path: "processors/task5_new_task"
```

## 性能优化

1. **图片处理**:
   - 保存原图和缩略图
   - 异步保存（可选）

2. **大模型调用**:
   - 超时设置（300秒）
   - 重试机制（可扩展）

3. **并发处理**:
   - BentoML并发连接限制
   - Worker进程数配置

## 日志管理

- 日志文件: `../data/logs/bentoml.log`
- 日志轮转: 5MB/文件，保留50个
- 日志级别: INFO
- 记录内容:
  - 请求信息（task_type, station_id）
  - 处理结果（成功/失败）
  - 错误详情

## 错误处理

统一的错误码定义：

| 错误码 | 说明 |
|--------|------|
| INVALID_TASK_TYPE | 无效的任务类型 |
| PROCESSOR_NOT_FOUND | 处理器未找到 |
| INVALID_INPUT | 输入验证失败 |
| PROCESSING_FAILED | 处理失败 |
| MODEL_API_ERROR | 大模型API错误 |

## 安全性

1. **输入验证**: 所有输入都经过验证
2. **文件大小限制**: 最大10MB
3. **并发限制**: 防止资源耗尽
4. **API密钥保护**: 通过环境变量管理

## 测试

运行测试脚本：

```bash
python api_server/test_service.py
```

测试内容：
- 健康检查
- 任务1处理
- 任务2处理

## 参考资料

- BentoML文档: https://docs.bentoml.org/
- DashScope文档: https://help.aliyun.com/zh/dashscope/

